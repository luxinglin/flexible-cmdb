<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/main.css">
    <title>Haier CMDB</title>
</head>

<body>

<div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="row">
            <div class="navbar-header col-sm-4 col-md-4">
                <div class="logo-well">
                    <a href="#">
                        <img src="assets/img/cmdb-logo.svg" alt="Neo4j World's Leading Graph Database" id="logo">
                    </a>
                </div>
                <div class="navbar-brand">
                    <div class="brand">Haier CMDB</div>
                </div>
            </div>

            <div class="navbar-header col-sm-4 col-md-4" style="padding-top: 15px;">
                <a href="ci.html">配置项</a>&nbsp;&nbsp;&nbsp;&nbsp;
                <a href="ci-relation.html">关系图</a>
            </div>


        </div>
    </div>
</div>

<div class="row">
    <div class="col-sm-4 col-md-4">
        <ul class="nav navbar-nav">
            <li>
                <form role="search" class="navbar-form" id="search">
                    <div class="form-group">
                        <select id="ciTypeSelect" class="form-control"
                                name="ciType" onchange="filterCiSelect()"></select>
                    </div>
                    <div class="form-group">
                        <!--<input id="ci" name="ci" type="text" list="ciSelect" class="form-control" />
                        <datalist id="ciSelect" >
                        </datalist>-->
                        <select id="ciSelect" class="form-control"
                                name="ci"></select>
                    </div>
                </form>
            </li>
        </ul>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        <!--新增业务系统-->
        <div id="add_BizSystemConfigItem" style="display: none" class="panel panel-default">
            <div class="panel-heading">新增业务系统</div>
            <div class="row">
                <form id="newBizSystemForm" class="form-horizontal addlabel">
                    <div class="form-group">
                        <label for="nameForInsert" class="col-sm-3 control-label">系统名称：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="name" id="nameForInsert" placeholder="系统名称"
                                   required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="codeForInsert" class="col-sm-3 control-label">系统编码：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="code" id="codeForInsert" placeholder="系统编码">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bizSystemDescForInsert" class="col-sm-3 control-label">系统描述：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="bizSystemDesc" id="bizSystemDescForInsert"
                                   placeholder="系统描述">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="personSetAForInsert" class="col-sm-3 control-label">责任人A：</label>
                        <div class="col-sm-8">
                            <select class="form-control" name="personSet.id" multiple id="personSetAForInsert"
                                    placeholder="责任人"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3"></label>
                        <div class="col-sm-8 pull-right">
                            <button class="btn btn-default" type="button" id="addBizSystemBtn">Add</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
        <!--新增服务器-->
        <div id="add_ServerConfigItem" style="display: none" class="panel panel-default">
            <div class="panel-heading">新增服务器</div>
            <div class="row">
                <form id="newServerForm" class="form-horizontal addlabel">
                    <div class="form-group">
                        <label for="uuidForInsert" class="col-sm-3 control-label">UUID：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="uuid" id="uuidForInsert" placeholder="系统名称"
                                   required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="snForInsert" class="col-sm-3 control-label">序列号：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="sn" id="snForInsert" placeholder="系统编码">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="brandForInsert" class="col-sm-3 control-label">品牌：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" name="brand" id="brandForInsert"
                                   placeholder="系统描述">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">Search Results</div>
            <table id="results" class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>系统名称</th>
                    <th>系统编码</th>
                    <th>系统描述</th>
                    <th>关联人员</th>
                    <th>关联服务器</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript">
    function search() {
        $.get("/bizSystem/findList?name=",
            function (data) {
                var t = $("table#results tbody").empty();
                if (!data) return;
                data = data.data;
                if (data.length < 1) return;
                data.forEach(function (bizSystem) {
                    $("<tr><td class='movie'>" + bizSystem.name + "</td><td>" + bizSystem.code + "</td><td>" + bizSystem.bizSystemDesc + "</td><td>" + bizSystem.personSet.length + "</td><td>" + bizSystem.serverSet.length + "</td><td><a href='#' onclick='deleteItem(" + bizSystem.id + ")'>删除</a></td></tr>").appendTo(t)
                });
            }, "json");
        return false;
    }

    $(function () {
        search();

        /**
         * 新增业务系统配置项
         */
        $("#addBizSystemBtn").on("click", function () {
            $.ajax({
                url: "/bizSystem",
                data: $("#newBizSystemForm").serialize(),
                type: "POST",
                dataType: 'json',
                success: function (data) {
                    if (data.status) {
                        search();
                    }
                },
                error: function (er) {
                    console.log(er)
                }
            });
        });

        /**
         * 加载配置项类型下拉框
         */
        $.ajax({
            url: "/configItem",
            type: "GET",
            dataType: 'json',
            success: function (data) {
                if (data.status) {
                    $("#ciTypeSelect").empty();
                    data.data.forEach(function (item) {
                        $("#ciTypeSelect").append("<option value='" + item.value + "'>" + item.name + "</option>");
                    });
                    $("#ciTypeSelect").prepend("<option value='' selected>--请选择--</option>")
                }
            },
            error: function (er) {
                console.log(er)
            }
        });

        /**
         * 加载人员列表
         */
        $.ajax({
            url: "/configItem/Person",
            type: "GET",
            dataType: "json",
            success: function (data) {
                $("#personSetAForInsert").empty();
                if (data.status) {
                    data.data.forEach(function (item) {
                        $("#personSetAForInsert").append("<option value='" + item.value + "'>" + item.name + "</option>");
                    });
                }
            }
        });
    });

    /**
     * 筛选出ci信息
     */
    function filterCiSelect() {
        $("#ciSelect").empty();
        var val = $("#ciTypeSelect").val();
        if (val != "") {
            $("div[id^=add_]").each(function () {
                $(this).css("display", "none");
            });
            $("#add_" + val).css("display", "block");

            $.ajax({
                url: "/configItem/" + val,
                type: "GET",
                dataType: 'json',
                success: function (data) {
                    if (data.status) {
                        data.data.forEach(function (item) {
                            $("#ciSelect").append("<option value='" + item.value + "'>" + item.name + "</option>");
                        });
                        $("#ciSelect").prepend("<option value='' selected>--请选择--</option>");
                    }
                },
                error: function (er) {
                    console.log(er)
                }
            });
        } else {
            $("#ciSelect").prepend("<option value='' selected>--请选择--</option>");
        }
    }

    /**
     * 配置项删除操作
     * @param id
     */
    function deleteItem(id) {
        console.log("to delete id: " + id);
        $.ajax({
            url: "/bizSystem/" + id,
            type: "DELETE",
            dataType: 'json',
            success: function (data) {
                if (data.status) {
                    search();
                }
            },
            error: function (er) {
                console.log(er)
            }
        });
    }

</script>


</body>
</html>
